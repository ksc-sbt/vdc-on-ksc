
# 如何在金山云上搭建专属虚拟数据中心.md

摘要

公有云服务商通过多租户共享物理机提供基于虚拟化技术的云服务器，在保证不同租户间安全隔离的前提下，提高物理机资源利用率，降低最终用户的购买成本。但某些用户希望自己拥有云服务器具有更好的隔离性，也就是希望所拥有的云服务器运行在自己独占的物理机上，满足行业合规性的要求，并更灵活的虚拟资源分配策略和具有更稳定的性能。

金山云提供了容器，共享云服务器，专属宿主机和云物理主机等完备的计算产品线，满足用户在资源使用粒度和隔离性等方面的不同需求。专属宿主机一方面给租户提供独占的物理资源，同时提供完备的服务器虚拟化管理和监控能力。用户可以在专属宿主机上创建虚拟化的专属云服务器。所创建的专属云服务器继承了标准共享云服务器在网络、存储等方面的能力，满足不同类型应用的上云需求。

和自建基于Vmware, OpenStack的私有虚拟化数据中心类似，我们需要为不同的计算负载提供不同的CPU、内存和硬盘等硬件配置的物理机。金山云云专属宿主机一方面及时采用最新的CPU，同时为计算密集型、内存密集型和IO密集型负载提供不同硬件配置，帮助客户在金山云搭建支撑不同计算负载的、完备的虚拟数据中心。下图利用金山云专属宿主机搭建企业专属虚拟数据中心的架构示意图。

![金山云专属虚拟数据中心(Dedicated Data Center Virtualization on KSC)架构](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/vdc-on-ksc-architecture.png)

在上图中，基于金山云提供的不同类型的专属宿主机，分别建立计算集群、数据集群和缓存集群。

|宿主机集群名称|宿主机型号|CPU类型|CPU Cores|Threads|CPU主频|内存(DDR4)|硬盘|专属云服务器系统盘|专属云服务器数据盘|使用场景|
|----|----|----|----|----|----|----|----|----|----|----|
|计算宿主机集群|计算型DC2|Intel® Xeon® Processor E5-2690 v4|14 * 2|28 * 2|2.6GHz|108GB|800G SSD|本地盘: 20G*|本地盘: <800G SSD; 云硬盘: 16000G * 3 SSD/云主机|计算密集型负载，比如Web服务|
|数据宿主机集群|标准型DS2|Intel® Xeon® Gold 6132 Processor|14 * 2|28 * 2|2.6GHz|356GB|5900GB SSD|本地盘: 20G*|本地盘: <5900GB SSD; 云硬盘: 16000G * 3 SSD/云主机|IO密集型负载，比如数据库|
|缓存宿主机集群|通用型DN2|Intel® Xeon® Platinum 8168 Processor|24 * 2|48 * 2|2.7GHz|734GB|无|云硬盘：20-500G|云硬盘: 16000G * 3 SSD/云主机|内存密集型资源，比如Redis缓存|
*说明：如果专属云服务器是Windows操作系统，缺省系统盘大小为50G.

下面通过在专属宿主机上运行用于运行缓存服务（比如Redis）的专属云服务器的操作过程，介绍金山云专属宿主机的使用方法。

本文包括下列内容：
* 网络规划
* 管理金山云专属宿主机
* 管理金山云专属云服务器
* 监控专属云宿主机和云服务器

更多详细信息，请参考[金山云宿主机在线帮助: https://docs.ksyun.com/products/71](https://docs.ksyun.com/products/71)

# 1 网络规划

对于企业数据中心而言，通常分为开发环境、测试环境和生产环境。出于信息安全考虑，这些环境之间需要进行一定程度的隔离。基于这个考虑，企业在金山云上建立专属虚拟数据中心时，建议针对开发、测试和生产环境建立不同的VPC。此外，建立一个独立的堡垒机VPC，该VPC用于管理用于云服务器访问控制和操作审计的堡垒机。堡垒机VPC和另外三个VPC之间通过对等连接(VPC Peering)进行互通。关于金山云云服务器访问控制和操作审计，以及本文所依赖的网络环境，请参考文章[《金山云云服务器访问控制和操作审计》：https://github.com/ksc-sbt/bastion/blob/master/金山云云服务器访问控制和操作审计.md](https://github.com/ksc-sbt/bastion/blob/master/金山云云服务器访问控制和操作审计.md)

# 2 管理金山云专属宿主机
当专属宿主机数量较多时，可把相同规格的专属宿主机分配到不同的专属宿主机集群中。

## 2.1 管理专属宿主机集群
下面创建一个包含“通用型DN2”规格的缓存宿主机集群，用户可以增加新的宿主机集群。下图是管理宿主机集群的界面。

![管理专属宿主机集群](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kdh-clusters.png)

## 2.1 管理专属宿主机
点击特定的专属宿主机集群，可进入集群的详情界面，该界面显示了集群中的专属宿主机列表。下图是“缓存集群“包含的两台“通用型DN2”规格的宿主机：
![专属宿主机集群详情](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kdh-cluster-detail.png)
此外，通过专属宿主机界面，也可以管理专属宿主机。操作界面如下：
![专属宿主机列表](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kdh-list.png)
在新建专属宿主机时，可以通过设置宿主机的虚拟核数来控制CPU超分比，也可以在专属宿主机创建后调整虚拟核数。当前，专属云宿主机的超分比最大为1:3

# 3 管理金山云专属云服务器

# 3.1 创建专属云服务器
在创建专属宿主机集群和专属宿主机后，下面就可以创建运行在专属宿主机上的专属云服务器。
首先从金山云控制台进入云服务器界面。
![管理专属宿主机集群](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kec-list.png)

然后点击“新建实例“，进入如下界面。
![创建专属云服务器](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kec-dedicated.png)，该界面是说明如下：
* 新建专属云服务器：由于需要在专属宿主机上创建云服务器，因此选择该选项；
* 所属集群：选择前面步骤已创建的专属宿主机集群“缓存集群”；
* 所属宿主机：该选项可指定“缓存集群”中的特定专属宿主机，也可以选择“自动分配“。因为我们希望云平台能根据集群内宿主机的资源情况自动选择专属宿主机，因此选择”自动分配“选项。
* CPU：指定专属云服务器的CPU数量。此处设置的数量不能超过该宿主机当前可用的CPU数量；
* 内存：指定专属云服务器的内存大小；其值不能超过宿主机上当前可用内存。
* 系统盘：因为“缓存集群”包含的宿主机规格为“通用型DN2”， 该规格专属宿主机上创建的云服务器只能是云硬盘，但大小可以达到最大500G。
* 数据盘：可创建基于云硬盘的数据盘。
* 购买数量：一次创建的专属云服务器数量，界面中设置为9。云平台将自动把这9台专属云服务器均衡分配的两台专属宿主机上。
* 监控专属云宿主机和云服务器
点击进入下一步。在”选择弹性IP“界面，选择“稍后购买”。
点击进入下一步，在“设置VPC"界面，设置相关的VPC(比如sbt-vpc)、子网（比如private_a）和安全组（sg-app）。
点击进入下一步，设置基本信息，界面如下：
![专属云服务器基本信息](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kec-setting.png)
最后选择“购买”，并提交订单后，将开始启动9台专属云服务器的创建。进入金山云云服务器控制台界面，将看到如下创建过程。
![专属云服务器基本信息](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kec-creating.png)

进入金山云宿主机管理控制，能看到新创建的9台专属云服务器分不到两台宿主机上。
![专属云服务器基本信息](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kdh-list2.png)

# 3.2 调整专属云服务器配置
在专属云服务器使用过程中，可以根据需要增加或者减少云服务器CPU和内存配置。比如，在下面界面中，把云服务器配置从4核32G变为8核64G。
![专属云服务器基本信息](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/change-configuration.png)
调整完成配置后，需要通过金山云云服务器控制台重新启动云服务器，CPU和内存变化才会生效。
```
[root@vm10-34-0-32 ~]# cat /proc/cpuinfo| grep "processor"| wc -l
8
[root@vm10-34-0-32 ~]# cat /proc/meminfo | grep MemTotal
MemTotal:       65808032 kB
```
# 3.3 迁移专属云服务器配置
有时为了优化专属宿主机资源，需要把专属云服务器从一台专属宿主机迁移到另外一台专属宿主机。下面把云服务器“ymq-srv200-7”从宿主机“ymq-kdh002“迁移到“ymq-kdh001"。
![专属云服务器基本信息](https://raw.githubusercontent.com/ksc-sbt/vdc-on-ksc/master/kec-relocate.png)

在整个迁移过程中，专属云服务器不会出现任何不可用情况。

# 4 监控专属云宿主机和云服务器


















